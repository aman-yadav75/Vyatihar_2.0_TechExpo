<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vyatihar Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
    apiKey: "AIzaSyClC9mvybO2oA_4UWlfeVZxsjrO4VOi7mM",
    authDomain: "vyatihar-live.firebaseapp.com",
    databaseURL: "https://vyatihar-live-default-rtdb.firebaseio.com",
    projectId: "vyatihar-live",
    storageBucket: "vyatihar-live.firebasestorage.app",
    messagingSenderId: "447656980301",
    appId: "1:447656980301:web:bc01def31d48fb63ab5104"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  onValue(ref(db, "live_class"), (snapshot) => {
  const data = snapshot.val();
  const liveBanner = document.getElementById("live-banner");

  if (data && data.status === "LIVE" && data.meetLink) {
    liveBanner.innerHTML = `
      <div class="fixed top-6 right-6 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg animate-bounce">
        ğŸ¥ <b>${data.subject}</b> class is LIVE! 
        <a href="${data.meetLink}" target="_blank" 
          class="underline font-semibold ml-2 bg-white text-green-600 px-2 py-1 rounded">Join Now</a>
      </div>
    `;
  } else {
    liveBanner.innerHTML = "";
  }
});

</script>

<div id="live-banner"></div>


<div id="announcement-box" class="fixed bottom-6 right-6 w-[350px]"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyClC9mvybO2oA_4UWlfeVZxsjrO4VOi7mM",
    authDomain: "vyatihar-live.firebaseapp.com",
    databaseURL: "https://vyatihar-live-default-rtdb.firebaseio.com",
    projectId: "vyatihar-live",
    storageBucket: "vyatihar-live.firebasestorage.app",
    messagingSenderId: "447656980301",
    appId: "1:447656980301:web:bc01def31d48fb63ab5104"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  onChildAdded(ref(db, "announcements"), (snapshot) => {
    const data = snapshot.val();
    const box = document.getElementById("announcement-box");
    const msgDiv = document.createElement("div");
    msgDiv.className = "bg-yellow-100 text-black p-3 mb-2 rounded-lg shadow-lg border-l-4 border-yellow-500";
    msgDiv.innerHTML = `ğŸ“¢ <strong>New:</strong> ${data.message}`;
    box.prepend(msgDiv);

    // Auto-hide after 10s
    setTimeout(() => msgDiv.remove(), 10000);
  });
</script>


<body class="bg-gray-50">
  <!-- Navbar -->
  <nav class="bg-white shadow-md p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-purple-600">Vyatihar</h1>
    <div>
      <span id="user" class="text-gray-700 mr-4"></span>
      <button onclick="logout()" class="text-red-500 hover:text-red-700">Logout</button>
    </div>
  </nav>
<!-- Main Section -->
<div class="max-w-5xl mx-auto p-6">
  <h2 id="welcome" class="text-2xl font-semibold text-gray-800 mb-6">
  ğŸ“š Welcome, Loading...
</h2>


  <div class="grid md:grid-cols-2 gap-6">
    <!-- Live Class Card -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-lg font-bold text-gray-700 mb-2">ğŸ¥ Live Class Status</h3>
      {% if user.live_status == "LIVE" %}
        <p class="text-green-600 font-semibold">AI & ML Class is LIVE!</p>
        <a href="https://meet.google.com/xyz" target="_blank" class="text-blue-600 underline">Join Now</a>
      {% else %}
        <p class="text-gray-500">No live class right now.</p>
      {% endif %}
    </div>

    <!-- Points -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-lg font-bold text-gray-700 mb-2">ğŸ† Your Coins</h3>
      <p class="text-2xl font-semibold text-purple-600">{{ user.coins }}</p>
    </div>

    <!-- Projects -->
    <div class="bg-white rounded-xl shadow-md p-6 md:col-span-2">
      <h3 class="text-lg font-bold text-gray-700 mb-2">ğŸ§  Your Projects</h3>
      <ul class="list-disc pl-5 text-gray-700">
        {% for project in user.projects %}
          <li>{{ project }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>


<!-- ğŸ“¢ Announcements -->
<section class="bg-white p-6 rounded-xl shadow-lg mt-6">
  <h2 class="text-lg font-semibold mb-3">ğŸ“¢ Latest Announcements</h2>
  <div class="max-h-48 overflow-y-auto">
    {% for ann in announcements %}
      <p class="border-b py-1 text-sm">
        {{ ann.message }}
        <span class="text-gray-500 text-xs">({{ ann.created_at.strftime('%d %b %Y') }})</span>
      </p>
    {% else %}
      <p class="text-gray-400 text-sm">No announcements yet.</p>
    {% endfor %}
  </div>
</section>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClC9mvybO2oA_4UWlfeVZxsjrO4VOi7mM",
      authDomain: "vyatihar-live.firebaseapp.com",
      databaseURL: "https://vyatihar-live-default-rtdb.firebaseio.com",
      projectId: "vyatihar-live",
      storageBucket: "vyatihar-live.firebasestorage.app",
      messagingSenderId: "447656980301",
      appId: "1:447656980301:web:bc01def31d48fb63ab5104"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

     // âœ… Flask already handles session-based auth â€” no redirect needed
    document.getElementById('user').innerText = "ğŸ‘‹ Hi, {{ user.name }}";


    const liveRef = ref(db, "live_class");
    onValue(liveRef, (snapshot) => {
      const data = snapshot.val();
      const status = document.getElementById("live-status");
      const link = document.getElementById("live-link");
      if (data && data.status === "LIVE") {
        status.innerHTML = `<b class='text-green-600'>LIVE Now!</b>`;
        link.innerHTML = `<a href='${data.meetLink}' target='_blank' class='underline'>Join Meet</a>`;
      } else {
        status.innerHTML = `<b class='text-red-500'>Offline</b>`;
        link.innerHTML = "";
      }
    });

    function logout() {
  // âœ… Call Flask backend logout route to clear session
  fetch('/logout')
    .then(() => {
      window.location.href = '/login';
    })
    .catch(err => {
      console.error('Logout error:', err);
      alert('Logout failed. Try again.');
    });
}


    let coins = parseInt(localStorage.getItem('vyatihar_coins') || 0);
    document.getElementById('coins').innerText = coins;
    window.addCoin = function() {
      coins++;
      localStorage.setItem('vyatihar_coins', coins);
      document.getElementById('coins').innerText = coins;
    };
  </script>


<!-- ğŸ’¬ AI Study Assistant -->
<div class="max-w-3xl mx-auto mt-10 bg-white rounded-xl shadow-lg p-6">
  <h3 class="text-xl font-semibold mb-4">ğŸ¤– Vyatihar Study Assistant</h3>
  <textarea id="ai-question" rows="3" placeholder="Ask any question (e.g., What is overfitting in ML?)"
    class="w-full border rounded p-3 mb-3"></textarea>
  <button onclick="askAI()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">Ask</button>
  <div id="ai-answer" class="mt-4 text-gray-700 whitespace-pre-wrap"></div>
</div>

<!-- ğŸ“š Notes Upload Section -->
<div class="max-w-3xl mx-auto mt-10 bg-white rounded-xl shadow-lg p-6">
  <h3 class="text-xl font-semibold mb-4">ğŸ“ Upload Your Notes</h3>
  <form action="/upload_note" method="POST" enctype="multipart/form-data">
    <input type="file" name="note" accept=".pdf,.txt,.jpg,.png" class="mb-3">
    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Upload</button>
  </form>
</div>


<script>
async function askAI() {
  const question = document.getElementById("ai-question").value.trim();
  if (!question) return alert("Please type a question!");

  document.getElementById("ai-answer").innerHTML = "â³ Thinking...";
  
  const res = await fetch("/ask_ai", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ question })
  });
  
  const data = await res.json();
  if (data.answer) {
    document.getElementById("ai-answer").innerHTML = "ğŸ’¡ " + data.answer;
  } else {
    document.getElementById("ai-answer").innerHTML = "âŒ Error: " + data.error;
  }
}


// Inject Jinja data into JS dynamically
const jinjaUser = {{ user | tojson | safe }};
document.getElementById("welcome").innerText = "ğŸ“š Welcome, " + jinjaUser.name + " ğŸ‘‹";

</script>


<script>
function logout() {
  // âœ… Call Flask logout endpoint directly
  fetch('/logout', { method: 'GET' })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url; // go to /login
      } else {
        window.location.href = '/login';
      }
    })
    .catch(err => {
      console.error('Logout error:', err);
      alert('Logout failed. Try again.');
    });
}
</script>

</body>
</html>
