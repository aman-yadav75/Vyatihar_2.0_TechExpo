<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vyatihar Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <!-- Navbar -->
  <nav class="bg-white shadow-md p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-purple-600">Vyatihar</h1>
    <div>
      <span id="user" class="text-gray-700 mr-4"></span>
      <button onclick="logout()" class="text-red-500 hover:text-red-700">Logout</button>
    </div>
  </nav>

  <!-- Main Section -->
  <div class="max-w-5xl mx-auto p-6">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6">üìö Your Dashboard</h2>

    <div class="grid md:grid-cols-2 gap-6">
      <!-- Live Class Card -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-bold text-gray-700 mb-2">üé• Live Class Status</h3>
        <p id="live-status" class="text-gray-600">Checking...</p>
        <a id="live-link" class="text-purple-500 mt-2 block"></a>
      </div>

      <!-- Points -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-bold text-gray-700 mb-2">üèÜ Your Coins</h3>
        <p id="coins" class="text-2xl font-semibold text-purple-600">0</p>
        <button onclick="addCoin()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded mt-4">Earn Coin</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClC9mvybO2oA_4UWlfeVZxsjrO4VOi7mM",
      authDomain: "vyatihar-live.firebaseapp.com",
      databaseURL: "https://vyatihar-live-default-rtdb.firebaseio.com",
      projectId: "vyatihar-live",
      storageBucket: "vyatihar-live.firebasestorage.app",
      messagingSenderId: "447656980301",
      appId: "1:447656980301:web:bc01def31d48fb63ab5104"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const user = localStorage.getItem('vyatihar_user');
    if (!user) window.location.href = '/login';
    document.getElementById('user').innerText = "üëã Hi, " + user;

    const liveRef = ref(db, "live_class");
    onValue(liveRef, (snapshot) => {
      const data = snapshot.val();
      const status = document.getElementById("live-status");
      const link = document.getElementById("live-link");
      if (data && data.status === "LIVE") {
        status.innerHTML = `<b class='text-green-600'>LIVE Now!</b>`;
        link.innerHTML = `<a href='${data.meetLink}' target='_blank' class='underline'>Join Meet</a>`;
      } else {
        status.innerHTML = `<b class='text-red-500'>Offline</b>`;
        link.innerHTML = "";
      }
    });

    function logout() {
      localStorage.removeItem('vyatihar_user');
      window.location.href = '/login';
    }

    let coins = parseInt(localStorage.getItem('vyatihar_coins') || 0);
    document.getElementById('coins').innerText = coins;
    window.addCoin = function() {
      coins++;
      localStorage.setItem('vyatihar_coins', coins);
      document.getElementById('coins').innerText = coins;
    };
  </script>


<!-- üí¨ AI Study Assistant -->
<div class="max-w-3xl mx-auto mt-10 bg-white rounded-xl shadow-lg p-6">
  <h3 class="text-xl font-semibold mb-4">ü§ñ Vyatihar Study Assistant</h3>
  <textarea id="ai-question" rows="3" placeholder="Ask any question (e.g., What is overfitting in ML?)"
    class="w-full border rounded p-3 mb-3"></textarea>
  <button onclick="askAI()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">Ask</button>
  <div id="ai-answer" class="mt-4 text-gray-700 whitespace-pre-wrap"></div>
</div>

<!-- üìö Notes Upload Section -->
<div class="max-w-3xl mx-auto mt-10 bg-white rounded-xl shadow-lg p-6">
  <h3 class="text-xl font-semibold mb-4">üìÅ Upload Your Notes</h3>
  <form action="/upload_note" method="POST" enctype="multipart/form-data">
    <input type="file" name="note" accept=".pdf,.txt,.jpg,.png" class="mb-3">
    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Upload</button>
  </form>
</div>


<script>
async function askAI() {
  const question = document.getElementById("ai-question").value.trim();
  if (!question) return alert("Please type a question!");

  document.getElementById("ai-answer").innerHTML = "‚è≥ Thinking...";
  
  const res = await fetch("/ask_ai", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ question })
  });
  
  const data = await res.json();
  if (data.answer) {
    document.getElementById("ai-answer").innerHTML = "üí° " + data.answer;
  } else {
    document.getElementById("ai-answer").innerHTML = "‚ùå Error: " + data.error;
  }
}
</script>

</body>
</html>
